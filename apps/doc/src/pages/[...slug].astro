---
import Layout from '@/layouts/layout.astro';
import { getCollection } from 'astro:content';

// Catch-all dynamic route that resolves MD/MDX files
// from src/data/pages based on the requested URL.
// Examples:
//  - /mcp            -> src/data/pages/mcp.mdx|md
//  - /foo/bar        -> src/data/pages/foo/bar.mdx|md
//  - /foo/bar/       -> src/data/pages/foo/bar/index.mdx|md
// Note: 404 handling is done via src/pages/404.astro, not here.

export async function getStaticPaths() {
  const entries = await getCollection('pages');
  const paths = entries
    .map((entry) => {
      let id = entry.id.replace(/\\/g, '/'); // normalize
      if (id.endsWith('/index')) id = id.slice(0, -('/index'.length));
      if (id === 'index' || id === '') return null; // ignore root
      // For catch-all routes ([...slug]), Astro expects a string path, not an array
      return { params: { slug: id } };
    })
    .filter(Boolean) as { params: { slug: string } }[];
  return paths;
}

const slugParam = Astro.params.slug as string | undefined;
const rel = (slugParam && slugParam.length ? slugParam : 'index').replace(/^\/|\/$/g, '');

// Build candidate import specifiers relative to this file (src/pages)
const candidates = [
  `../data/pages/${rel}.mdx`,
  `../data/pages/${rel}.md`,
  `../data/pages/${rel}/index.mdx`,
  `../data/pages/${rel}/index.md`,
];

// Eagerly import all data MD/MDX files from the dedicated pages folder
const modules = import.meta.glob('../data/pages/**/*.{md,mdx}', { eager: true });

let MatchedContent: any = null;
let frontmatter: Record<string, any> | undefined;
for (const key of candidates) {
  const mod = modules[key] as any | undefined;
  if (mod && mod.default) {
    MatchedContent = mod.default;
    frontmatter = mod.frontmatter || mod?.content?.frontmatter;
    break;
  }
}
---
<Layout>
  {/* Render the matched MD/MDX content component. Given getStaticPaths(), this should always be defined. */}
  <div class="prose-markdown max-w-none">
    <MatchedContent />
  </div>
</Layout>
